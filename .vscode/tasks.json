{
	"version": "2.0.0",
	"tasks": [
		{
			"label": "API: migrate",
			"type": "shell",
			"command": "cd api && DEBUG=1 SECRET_KEY=test .venv/bin/python manage.py migrate",
			"group": "build",
			"problemMatcher": [
				"$python"
			]
		},
		{
			"label": "API: lint (ruff)",
			"type": "shell",
			"command": "cd api && .venv/bin/ruff check .",
			"group": "test",
			"problemMatcher": [
				{
					"owner": "ruff",
					"fileLocation": [
						"relative",
						"${workspaceFolder}"
					],
					"pattern": {
						"regexp": "^(.*?):(\\d+):(\\d+): (.*)$",
						"file": 1,
						"line": 2,
						"column": 3,
						"message": 4
					}
				}
			]
		},
		{
			"label": "API: format (ruff)",
			"type": "shell",
			"command": "cd api && .venv/bin/ruff format",
			"group": "build",
			"problemMatcher": []
		},
		{
			"label": "API: runserver (DEBUG)",
			"type": "shell",
			"command": "cd api && DEBUG=1 SECRET_KEY=test .venv/bin/python manage.py runserver 127.0.0.1:8000",
			"group": "build",
			"isBackground": true,
			"problemMatcher": [
				{
					"owner": "python",
					"pattern": {
						"regexp": ".*",
						"file": 1,
						"location": 2,
						"message": 3
					},
					"background": {
						"activeOnStart": true,
						"beginsPattern": ".*Starting development server.*",
						"endsPattern": ".*Starting development server.*"
					}
				}
			]
		},
		{
			"label": "API: test (accounts+billing+exports)",
			"type": "shell",
			"command": "cd api && DEBUG=1 SECRET_KEY=test .venv/bin/python manage.py test -v 2 accounts.tests.test_health billing.tests.test_quota billing.tests.test_usage billing.tests.test_webhooks exports.tests.test_determinism orgs.tests.test_invites billing.tests.test_seats billing.tests.test_bundles_and_seats billing.tests.test_enterprise_allocations billing.tests.test_portal",
			"group": "test",
			"problemMatcher": [
				"$python"
			]
		},
		{
			"label": "API: test (RLS on Postgres)",
			"type": "shell",
			"command": "cd api && DEBUG=1 SECRET_KEY=test .venv/bin/python manage.py test -v 2 db_policies.tests",
			"group": "test",
			"problemMatcher": [
				"$python"
			],
			"options": {
				"env": {
					"DJANGO_SETTINGS_MODULE": "app.settings",
					"DATABASE_URL": "postgresql://appuser:changeme2@127.0.0.1:5432/granterstellar"
				}
			}
		},
		{
			"label": "Web: lint",
			"type": "shell",
			"command": "cd web && npm run lint",
			"group": "test",
			"problemMatcher": [
				{
					"owner": "eslint",
					"fileLocation": [
						"relative",
						"${workspaceFolder}"
					],
					"pattern": {
						"regexp": "^(.*?): line (\\d+), col (\\d+), (.*)$",
						"file": 1,
						"line": 2,
						"column": 3,
						"message": 4
					}
				}
			]
		},
		{
			"label": "Web: dev",
			"type": "shell",
			"command": "cd web && npm run dev",
			"group": "build",
			"isBackground": true,
			"problemMatcher": [
				{
					"owner": "vite",
					"pattern": {
						"regexp": ".*",
						"file": 1,
						"location": 2,
						"message": 3
					},
					"background": {
						"activeOnStart": true,
						"beginsPattern": ".*Local:.*http://.*",
						"endsPattern": ".*ready in .*"
					}
				}
			]
		},
		{
			"label": "API: celery worker",
			"type": "shell",
			"command": "cd api && EXPORTS_ASYNC=1 CELERY_BROKER_URL=redis://localhost:6379/0 CELERY_RESULT_BACKEND=redis://localhost:6379/1 .venv/bin/celery -A app.celery:app worker -l info",
			"group": "build",
			"isBackground": true,
			"problemMatcher": [
				{
					"owner": "celery",
					"pattern": {
						"regexp": ".*",
						"file": 1,
						"location": 2,
						"message": 3
					},
					"background": {
						"activeOnStart": true,
						"beginsPattern": ".*\\[tasks\\].*",
						"endsPattern": ".*ready\\..*"
					}
				}
			]
		},
		{
			"label": "API: seed demo",
			"type": "shell",
			"command": "cd api && DEBUG=1 SECRET_KEY=test .venv/bin/python manage.py seed_demo",
			"group": "none",
			"problemMatcher": []
		},
		{
			"label": "Dev: API + Web",
			"type": "shell",
			"command": "echo Starting API and Web...",
			"dependsOn": [
				"API: migrate",
				"API: runserver (DEBUG)",
				"Web: dev"
			],
			"problemMatcher": []
		},
		{
			"label": "API: test (ai)",
			"type": "shell",
			"command": "cd api && DEBUG=1 SECRET_KEY=test .venv/bin/python manage.py test -v 2 ai/tests",
			"group": "test"
		},
		{
			"label": "Docs: link check",
			"type": "shell",
			"command": "python3 scripts/linkcheck.py",
			"group": "test",
			"problemMatcher": []
		},
		{
			"label": "Web: test",
			"type": "shell",
			"command": "cd web && npm run test",
			"group": "test",
			"problemMatcher": []
		},
		{
			"label": "Web: test (watch)",
			"type": "shell",
			"command": "cd web && npm run test:watch",
			"group": "test",
			"isBackground": true,
			"problemMatcher": []
		},
		{
			"label": "Dev: API (Stripe test env)",
			"type": "shell",
			"command": "cd api && DEBUG=1 SECRET_KEY=test STRIPE_SECRET_KEY=sk_test_51S14QXLEGz5pojCYom1waFKIZvynk8bC0xMeymPOA9NV0Z5g8XMtPlJxFP95Vu9mhTFSv2xX05qsxeYc5VU7vuLE00EtfQlUST STRIPE_WEBHOOK_SECRET=whsec_a3f72ee46d6387a5bcbfc64224246df68ea9270296205a11446c9195bad36a76 PUBLIC_BASE_URL=http://127.0.0.1:8000 .venv/bin/python manage.py runserver 127.0.0.1:8000",
			"isBackground": true,
			"group": "build"
		},
		{
			"label": "Dev: API (Stripe debug 8010)",
			"type": "shell",
			"command": "cd api && DEBUG=1 SECRET_KEY=test STRIPE_SECRET_KEY=sk_test_51S14QXLEGz5pojCYom1waFKIZvynk8bC0xMeymPOA9NV0Z5g8XMtPlJxFP95Vu9mhTFSv2xX05qsxeYc5VU7vuLE00EtfQlUST PUBLIC_BASE_URL=http://127.0.0.1:8010 .venv/bin/python manage.py runserver 127.0.0.1:8010",
			"isBackground": true,
			"group": "build"
		},
		{
			"label": "Billing: create checkout (demo, 1 seat)",
			"type": "shell",
			"command": "cd api && ACCESS=$(curl -sS -X POST http://127.0.0.1:8000/api/token -H 'Content-Type: application/json' -d '{\"username\":\"demo\",\"password\":\"demo12345\"}' | python3 -c 'import sys,json;print(json.load(sys.stdin)[\"access\"])') && echo \"Token ok\" && curl -sS -X POST http://127.0.0.1:8000/api/billing/checkout -H \"Authorization: Bearer $ACCESS\" -H 'Content-Type: application/json' -d '{\"quantity\":1}'",
			"isBackground": false,
			"group": "none"
		},
		{
			"label": "Billing: Open Stripe Checkout (1 seat)",
			"type": "shell",
			"command": "cd api && ACCESS=$(curl -sS -X POST http://127.0.0.1:8000/api/token -H 'Content-Type: application/json' -d '{\"username\":\"stripeuser\",\"password\":\"test12345\"}' | python3 -c 'import sys,json;print(json.load(sys.stdin)[\"access\"])') && URL=$(curl -sS -X POST http://127.0.0.1:8000/api/billing/checkout -H \"Authorization: Bearer $ACCESS\" -H 'Content-Type: application/json' -d '{\"quantity\":1}' | python3 -c 'import sys,json;print(json.load(sys.stdin)[\"url\"])') && echo \"Opening: $URL\" && open \"$URL\"",
			"group": "none"
		},
		{
			"label": "Stripe: Listen (forward â†’ 8000)",
			"type": "shell",
			"command": "stripe listen --print-secret --forward-to http://127.0.0.1:8000/api/stripe/webhook",
			"isBackground": true,
			"group": "build"
		}
	]
}