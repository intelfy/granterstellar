import{r as t,j as i}from"./vendor-react-CfCdiEH_.js";import{a as n,o as a,s,b as o,c as l}from"./core-VSXNFQTj.js";import{f as r}from"./formatDiscount-BRtx8JzC.js";import"./vendor-ByYHSpNA.js";function d({before:e="",after:n=""}){if(!e&&!n)return null;const a=t.useMemo((()=>{const t=(e||"").split(/(\s+)/),i=(n||"").split(/(\s+)/),a=t.length,s=i.length,o=Array.from({length:a+1},(()=>new Array(s+1).fill(0)));for(let e=a-1;e>=0;e--)for(let n=s-1;n>=0;n--)o[e][n]=t[e]===i[n]?o[e+1][n+1]+1:Math.max(o[e+1][n],o[e][n+1]);const l=[];let r=0,d=0;for(;r<a&&d<s;)t[r]===i[d]?(l.push({t:"eq",v:t[r]}),r++,d++):o[r+1][d]>=o[r][d+1]?(l.push({t:"del",v:t[r]}),r++):(l.push({t:"ins",v:i[d]}),d++);for(;r<a;)l.push({t:"del",v:t[r++]});for(;d<s;)l.push({t:"ins",v:i[d++]});return l}),[e,n]);return i.jsxs("div",{children:[i.jsx("div",{children:"Changes"}),i.jsx("div",{style:{border:"1px solid #ddd",padding:8},children:a.map(((e,t)=>"ins"===e.t?i.jsx("span",{"data-testid":"diff-ins",style:{background:"#e6ffed"},children:e.v},t):"del"===e.t?i.jsx("span",{"data-testid":"diff-del",style:{background:"#ffeef0",textDecoration:"line-through"},children:e.v},t):i.jsx("span",{children:e.v},t)))}),i.jsxs("div",{style:{display:"flex",gap:12,marginTop:8},children:[i.jsxs("div",{style:{flex:1},children:[i.jsx("div",{children:"Previous"}),i.jsx("pre",{children:e||"—"})]}),i.jsxs("div",{style:{flex:1},children:[i.jsx("div",{children:"Draft"}),i.jsx("pre",{children:n||"—"})]})]})]})}function c({token:e,orgId:a,proposal:s,onSaved:r,_usage:d,_onUpgrade:c}){var u,h,v,p,x;const[g,j]=t.useState(null),[f,m]=t.useState(!1),[y,b]=t.useState(""),[k,S]=t.useState(0),[w,_]=t.useState({}),[C,I]=t.useState(""),[T,O]=t.useState(""),[P,$]=t.useState(""),[E,A]=t.useState(""),[D,U]=t.useState(null),[F,L]=t.useState(""),[R,N]=t.useState(""),[q,M]=t.useState({}),[H,G]=t.useState(!1),[W,z]=t.useState(""),[J,B]=t.useState(""),[K,Q]=t.useState(null),X=(null==g?void 0:g.sections)||[],V=X[k],Y=(null==(v=null==(h=null==(u=null==s?void 0:s.content)?void 0:u.sections)?void 0:h[null==V?void 0:V.id])?void 0:v.content)||"",Z=(null==(p=null==s?void 0:s.content)?void 0:p.sections)||{},ee=X.length>0&&X.every((e=>!!Z[e.id]));t.useEffect((()=>{var e,t;const i=null==(t=null==(e=null==s?void 0:s.content)?void 0:e.meta)?void 0:t.note;B("string"==typeof i?i:"")}),[null==s?void 0:s.id]),t.useEffect((()=>{(async()=>{try{const t=await n("/me",{token:e});Q((null==t?void 0:t.user)||null)}catch{}})()}),[e]);return i.jsxs("div",{children:[i.jsxs("div",{style:{borderTop:"1px solid #eee",paddingTop:8,marginTop:8},children:[i.jsxs("div",{children:[i.jsx("strong",{children:"Author"}),": #",s.author]}),i.jsxs("div",{children:[i.jsx("strong",{children:"Created"}),": ",s.created_at?new Date(s.created_at).toLocaleString():"—"]}),i.jsxs("div",{children:[i.jsx("strong",{children:"Last edited"}),": ",s.last_edited?new Date(s.last_edited).toLocaleString():"—",K?` by ${K.username||"you"}`:"",D?" (just now)":""]}),i.jsxs("div",{style:{marginTop:6},children:[i.jsx("div",{children:"Internal note"}),i.jsx("textarea",{"data-testid":"note-text",rows:2,value:J,onChange:e=>B(e.target.value),placeholder:"Add a note for collaborators"}),i.jsx("div",{children:i.jsx("button",{"data-testid":"note-save",onClick:async()=>{const t={...s.content||{}};t.meta={...t.meta||{},note:J};const i={content:t,schema_version:s.schema_version||(null==g?void 0:g.schema_version)||"v1"};m(!0),b("");try{await n(`/proposals/${s.id}/`,{method:"PATCH",token:e,orgId:a||void 0,body:i}),U(new Date),await(null==r?void 0:r())}catch{b("Save note failed")}finally{m(!1)}},disabled:f,children:"Save Note"})})]})]}),g?i.jsxs("div",{children:[i.jsxs("div",{children:[i.jsxs("div",{children:[i.jsxs("strong",{children:["Section ",k+1," / ",X.length,":"]})," ",null==V?void 0:V.title]}),i.jsxs("div",{children:["Schema: ",(null==g?void 0:g.schema_version)||"v1",D&&i.jsxs("span",{children:[" · Last saved ",D.toLocaleTimeString()]})]})]}),i.jsxs("div",{children:[((null==V?void 0:V.inputs)||[]).map((e=>i.jsxs("div",{children:[i.jsx("label",{children:e}),i.jsx("textarea",{rows:2,value:w[e]||"",onChange:t=>_((i=>({...i,[e]:t.target.value})))})]},e))),i.jsxs("div",{children:[i.jsx("label",{htmlFor:`file-${(null==V?void 0:V.id)||"section"}`,children:"Attach files (pdf, docx, txt, images)"}),i.jsx("input",{id:`file-${(null==V?void 0:V.id)||"section"}`,type:"file",accept:".pdf,.docx,.txt,image/*",onChange:async t=>{const i=t.target.files&&t.target.files[0];if(i&&V){G(!0),z("");try{const n=await l("/files",{token:e,orgId:a||void 0,file:i});M((e=>({...e,[V.id]:[...e[V.id]||[],{...n,name:i.name}]}))),t.target.value=""}catch{z("Upload failed")}finally{G(!1)}}}}),H&&i.jsx("span",{children:" Uploading…"}),W&&i.jsx("div",{children:W}),V&&(null==(x=q[V.id])?void 0:x.length)>0&&i.jsxs("div",{children:[i.jsx("div",{children:"Files for this section"}),i.jsx("ul",{children:q[V.id].map(((e,t)=>i.jsxs("li",{children:[i.jsx("div",{children:i.jsx("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",children:e.name||`file-${t+1}`})}),e.ocr_text&&i.jsxs("div",{children:[i.jsx("div",{children:"OCR preview"}),i.jsx("textarea",{readOnly:!0,rows:4,value:e.ocr_text})]})]},t)))})]})]}),i.jsxs("div",{children:[i.jsx("button",{onClick:async()=>{if(V){m(!0),b("");try{const t=await o("/ai/write",{method:"POST",token:e,orgId:a||void 0,body:{proposal_id:s.id,section_id:V.id,answers:w,file_refs:V&&q[V.id]?q[V.id]:[]}});I((null==t?void 0:t.draft_text)||"")}catch{b("Write failed")}finally{m(!1)}}},disabled:f,children:"Write"}),i.jsx("input",{placeholder:"Change request (optional)",value:T,onChange:e=>O(e.target.value)}),i.jsx("button",{onClick:async()=>{if(V){m(!0),b("");try{const t=await o("/ai/revise",{method:"POST",token:e,orgId:a||void 0,body:{proposal_id:s.id,section_id:V.id,base_text:C||Y,change_request:T,file_refs:V&&q[V.id]?q[V.id]:[]}});I((null==t?void 0:t.draft_text)||C)}catch{b("Revise failed")}finally{m(!1)}}},disabled:f||!(C||Y),children:"Revise"}),i.jsx("button",{onClick:async()=>{var t;if(!V)return;const i={...s.content||{},sections:{...(null==(t=s.content)?void 0:t.sections)||{}}};i.sections[V.id]={title:V.title||V.id,content:C||Y||""};const o={content:i,schema_version:s.schema_version||(null==g?void 0:g.schema_version)||"v1"};m(!0),b("");try{await n(`/proposals/${s.id}/`,{method:"PATCH",token:e,orgId:a||void 0,body:o}),U(new Date),await(null==r?void 0:r()),k<X.length-1&&(S(k+1),_({}),I(""),O(""))}catch{b("Save failed")}finally{m(!1)}},disabled:f||!(C||Y),children:"Approve & Save"})]}),i.jsx("div",{children:i.jsxs("div",{style:{display:"flex",gap:12,marginTop:8},children:[i.jsxs("div",{style:{flex:1},children:[i.jsx("div",{children:"Previous"}),i.jsx("pre",{children:Y||"—"})]}),i.jsxs("div",{style:{flex:1},children:[i.jsx("div",{children:"Draft"}),i.jsx("pre",{children:C||Y||"—"})]})]})}),y&&i.jsx("div",{children:y}),f&&i.jsx("div",{children:"Working…"})]}),i.jsxs("div",{children:[i.jsxs("div",{children:["Approved sections: ",Object.keys(Z).length," / ",X.length]}),ee&&i.jsxs("div",{children:[i.jsx("div",{children:"Final formatting (runs after all sections are approved)"}),i.jsx("input",{placeholder:"Template hint (optional)",value:F,onChange:e=>L(e.target.value)}),i.jsx("button",{onClick:async()=>{var t,i,n;if(ee){m(!0),b("");try{const l=[],r=[];for(const e of X){const a=(null==(t=null==Z?void 0:Z[e.id])?void 0:t.title)||e.title||e.id,s=(null==(i=null==Z?void 0:Z[e.id])?void 0:i.content)||"";l.push(`# ${a}\n\n${s}`),(null==(n=q[e.id])?void 0:n.length)&&r.push(...q[e.id])}const d=l.join("\n\n"),c=await o("/ai/format",{method:"POST",token:e,orgId:a||void 0,body:{proposal_id:s.id,full_text:d,template_hint:F||void 0,file_refs:r}});N((null==c?void 0:c.formatted_text)||"")}catch{b("Final format failed")}finally{m(!1)}}},disabled:f,children:"Run Final Formatting"}),R&&i.jsxs("div",{children:[i.jsx("div",{children:"Formatted preview"}),i.jsx("textarea",{readOnly:!0,rows:10,value:R})]})]})]})]}):i.jsxs("div",{children:[i.jsx("div",{children:"Plan your proposal"}),i.jsx("input",{value:P,onChange:e=>$(e.target.value),placeholder:"Grant URL (optional)"}),i.jsx("textarea",{rows:3,value:E,onChange:e=>A(e.target.value),placeholder:"Or paste a brief specification (optional)"}),i.jsx("button",{onClick:async()=>{m(!0),b("");try{const t=P?{grant_url:P}:{text_spec:E||"General grant"},i=await o("/ai/plan",{method:"POST",token:e,orgId:a||void 0,body:t});j(i),S(0),_({}),I(""),O("")}catch{b("Failed to load plan")}finally{m(!1)}},disabled:f,children:"Start"}),y&&i.jsx("div",{children:y})]})]})}function u({token:o,selectedOrgId:l}){var d,u,h,v,p,x,g;const[j,f]=t.useState([]),[m,y]=t.useState(!1),[b,k]=t.useState(!1),[S,w]=t.useState(null),[_,C]=t.useState(null),[I,T]=t.useState(!1),[O,P]=t.useState({}),[$,E]=t.useState((()=>localStorage.getItem("orgId")||"")),[A,D]=t.useState(null),U=e=>({ok:"OK",active_cap_reached:"Active proposal cap reached for your plan",monthly_cap_reached:"Monthly creation limit reached",quota:"Quota reached"}[e]||e),F=e=>e&&"free"!==e.tier&&("active"===e.status||"trialing"===e.status),L=async()=>{try{const e=await n("/usage",{token:o,orgId:$||void 0});C(e)}catch{}finally{T(!0)}},R=async()=>{y(!0);try{const e=await n("/proposals/",{token:o,orgId:$||void 0});f(Array.isArray(e)?e:e.results||[])}finally{y(!1)}};t.useEffect((()=>{try{const e=JSON.parse(localStorage.getItem("exportFormats")||"{}");e&&"object"==typeof e&&P(e)}catch{}}),[]),t.useEffect((()=>{try{localStorage.setItem("exportFormats",JSON.stringify(O))}catch{}}),[O]),t.useEffect((()=>{R(),L()}),[o,$]),t.useEffect((()=>{$?localStorage.setItem("orgId",$):localStorage.removeItem("orgId")}),[$]),t.useEffect((()=>{void 0!==l&&l!==$&&E(l||"")}),[l]);const N=async()=>{try{const{url:e}=await n("/billing/checkout",{method:"POST",token:o,orgId:$||void 0,body:{}});if(e){try{const t=new URL(e);a(t.toString())||s(t.toString(),["https://checkout.stripe.com"])}catch{a(e)}await L()}}catch{alert("Checkout unavailable")}};return i.jsxs("section",{children:[i.jsxs("div",{children:[i.jsx("h2",{children:"My Proposals"}),_&&i.jsxs("div",{children:["Tier: ",_.tier," · Status: ",_.status," · Active: ",(null==(d=_.usage)?void 0:d.active)??"-",(null==(u=_.limits)?void 0:u.monthly_cap)?` · Created this month: ${(null==(h=_.usage)?void 0:h.created_this_period)??"-"}/${null==(v=_.limits)?void 0:v.monthly_cap}`:"",(null==(p=_.subscription)?void 0:p.current_period_end)?` · Period ends: ${new Date(_.subscription.current_period_end).toLocaleDateString()}`:"",(null==(x=_.subscription)?void 0:x.discount)?i.jsxs(i.Fragment,{children:[" · ",i.jsxs("span",{"data-testid":"promo-banner","aria-label":"active-promo",children:["Promo: ",r(_.subscription.discount)]})]}):"",!1===_.can_create_proposal&&_.reason?` · New proposal blocked: ${U(_.reason)}`:""]}),i.jsxs("div",{children:[i.jsx("input",{placeholder:"Org ID (optional)",value:$,onChange:e=>E(e.target.value)}),i.jsx("button",{disabled:b||!I||_&&!1===_.can_create_proposal,onClick:async()=>{k(!0);try{if(_&&!1===_.can_create_proposal){const e=_.reason||"quota";return void alert(`Paywall: ${U(e)}. Click Upgrade to continue.`)}await n("/proposals/",{method:"POST",token:o,orgId:$||void 0,body:{content:{meta:{title:"Untitled"},sections:{}},schema_version:"v1"}}),await R(),await L()}catch{if(402===e.status&&e.data){const t=e.data.reason||"quota";alert(`Paywall: ${U(t)}. Click Upgrade to continue.`)}else alert("Create failed: "+e.message)}finally{k(!1)}},children:"New"}),_&&!1===_.can_create_proposal&&i.jsx("button",{onClick:N,children:"Upgrade"}),i.jsx("button",{onClick:async()=>{try{const e=await n("/billing/portal",{method:"GET",token:o,orgId:$||void 0});if(null==e?void 0:e.url)try{const t=new URL(e.url);a(t.toString())||s(t.toString(),["https://billing.stripe.com"])}catch{a(e.url)}}catch{alert("Portal unavailable")}},children:"Billing Portal"}),(null==(g=null==_?void 0:_.subscription)?void 0:g.cancel_at_period_end)?i.jsx("button",{onClick:async()=>{try{await n("/billing/resume",{method:"POST",token:o,orgId:$||void 0,body:{}}),await L(),alert("Subscription resumed.")}catch{alert("Resume failed")}},children:"Resume"}):i.jsx("button",{onClick:async()=>{try{await n("/billing/cancel",{method:"POST",token:o,orgId:$||void 0,body:{}}),await L(),alert("Subscription will cancel at period end.")}catch{alert("Cancel failed")}},children:"Cancel at period end"})]})]}),m&&i.jsx("div",{children:"Loading…"}),i.jsx("ul",{children:j.map((t=>{var a,l;return i.jsxs("li",{children:[i.jsxs("div",{children:[i.jsxs("strong",{children:["#",t.id]})," — ",(null==(l=null==(a=t.content)?void 0:a.meta)?void 0:l.title)||"Untitled"," — ",t.state,i.jsxs("select",{value:O[t.id]||"pdf",onChange:e=>P((i=>({...i,[t.id]:e.target.value}))),children:[i.jsx("option",{value:"pdf",children:"PDF"}),i.jsx("option",{value:"docx",children:"DOCX"}),i.jsx("option",{value:"md",children:"Markdown"})]}),S===t.id&&i.jsx("span",{children:"Exporting…"}),i.jsx("button",{disabled:S===t.id,onClick:()=>(async(t,i="pdf")=>{w(t);try{const e=await n("/exports",{method:"POST",token:o,orgId:$||void 0,body:{proposal_id:t,format:i}});if(e.url)return void s(e.url);const a=e.id;for(let t=0;t<20;t++){await new Promise((e=>setTimeout(e,500)));const e=await n(`/exports/${a}`,{token:o,orgId:$||void 0});if(e.url)return void s(e.url)}alert("Export still processing; try again later")}catch{alert("Export failed: "+e.message)}finally{w(null)}})(t.id,O[t.id]||"pdf"),children:"Export"}),i.jsx("button",{onClick:()=>D((e=>e===t.id?null:t.id)),children:A===t.id?"Close Author":"Open Author"}),"archived"!==t.state?i.jsx("button",{disabled:!F(_),title:F(_)?"":"Paid plan required to archive",onClick:()=>(async e=>{var t;try{await n(`/proposals/${e.id}/`,{method:"PATCH",token:o,orgId:$||void 0,body:{state:"archived"}}),await R(),await L()}catch(i){alert("Archive failed: "+((null==(t=null==i?void 0:i.data)?void 0:t.error)||i.message))}})(t),children:"Archive"}):i.jsx("button",{onClick:()=>(async e=>{var t,i;try{await n(`/proposals/${e.id}/`,{method:"PATCH",token:o,orgId:$||void 0,body:{state:"draft"}}),await R(),await L()}catch(a){402===a.status?alert("Unarchive blocked: "+U(null==(t=null==a?void 0:a.data)?void 0:t.reason)):alert("Unarchive failed: "+((null==(i=null==a?void 0:a.data)?void 0:i.error)||a.message))}})(t),children:"Unarchive"})]}),A===t.id&&i.jsx(c,{token:o,orgId:$||void 0,proposal:t,usage:_,onUpgrade:N,onSaved:async()=>{await R()}})]},t.id)}))})]})}function h({token:e,onSelectOrg:a}){const[s,o]=t.useState([]),[l,r]=t.useState(""),[d,c]=t.useState(""),[u,h]=t.useState(""),[v,p]=t.useState({}),[x,g]=t.useState(""),[j,f]=t.useState("member"),[m,y]=t.useState({}),[b,k]=t.useState(""),S=async()=>{try{o(await n("/orgs/",{token:e}))}catch{}},w=async t=>{try{const i=await n(`/orgs/${t}/members/`,{token:e});p((e=>({...e,[t]:i})))}catch{}},_=async t=>{try{const i=await n(`/orgs/${t}/invites/`,{token:e});y((e=>({...e,[t]:i})))}catch{}};t.useEffect((()=>{S()}),[e]);return i.jsxs("section",{children:[i.jsxs("div",{children:[i.jsx("h2",{children:"Organizations"}),i.jsxs("div",{children:[i.jsx("input",{placeholder:"New org name",value:l,onChange:e=>r(e.target.value)}),i.jsx("input",{placeholder:"Description (optional)",value:d,onChange:e=>c(e.target.value)}),i.jsx("button",{onClick:async()=>{l&&(await n("/orgs/",{method:"POST",token:e,body:{name:l,description:d}}),r(""),c(""),S())},children:"Create"})]})]}),i.jsx("ul",{children:s.map((t=>{var s;return i.jsxs("li",{children:[i.jsxs("div",{children:[i.jsxs("strong",{children:["#",t.id]})," ",t.name,i.jsxs("span",{children:[" ",t.description]}),i.jsxs("span",{children:[" admin: ",null==(s=t.admin)?void 0:s.username]}),i.jsx("button",{onClick:()=>a(String(t.id)),children:"Use"}),i.jsx("button",{onClick:()=>{const e=u===String(t.id);h(e?"":String(t.id)),e||(w(t.id),_(t.id))},children:u===String(t.id)?"Hide":"Manage"}),i.jsx("button",{onClick:()=>(async t=>{confirm("Delete this organization?")&&(await n(`/orgs/${t}/`,{method:"DELETE",token:e}),S())})(t.id),children:"Delete"})]}),u===String(t.id)&&i.jsxs("div",{children:[i.jsxs("div",{children:[i.jsx("div",{children:"Members"}),i.jsx("div",{children:"Invite by email"}),i.jsx("input",{placeholder:"name@example.com",value:x,onChange:e=>g(e.target.value)}),i.jsxs("select",{value:j,onChange:e=>f(e.target.value),children:[i.jsx("option",{value:"member",children:"member"}),i.jsx("option",{value:"admin",children:"admin"})]}),i.jsx("button",{onClick:()=>(async t=>{if(!x)return;const i=await n(`/orgs/${t}/invites/`,{method:"POST",token:e,body:{email:x,role:j}});g(""),await _(t),alert(`Invite created. Token (dev): ${i.token}`)})(t.id),children:"Invite"})]}),i.jsx("ul",{children:(v[t.id]||[]).map((a=>i.jsxs("li",{children:[a.user.username," (",a.user.id,") — ",a.role,i.jsx("button",{onClick:()=>(async(t,i)=>{await n(`/orgs/${t}/members/`,{method:"DELETE",token:e,body:{user_id:i}}),w(t)})(t.id,a.user.id),children:"Remove"})]},a.user.id)))}),i.jsxs("div",{children:[i.jsx("div",{children:"Pending invites"}),i.jsx("ul",{children:(m[t.id]||[]).map((a=>i.jsxs("li",{children:[a.email," — ",a.role," ",a.accepted_at?"(accepted)":a.revoked_at?"(revoked)":"(pending)",!a.accepted_at&&!a.revoked_at&&i.jsxs(i.Fragment,{children:[i.jsx("button",{onClick:()=>(async(t,i)=>{await n(`/orgs/${t}/invites/`,{method:"DELETE",token:e,body:{id:i}}),await _(t)})(t.id,a.id),children:"Revoke"}),i.jsxs("span",{children:[" token: ",a.token]})]})]},a.id)))})]}),i.jsxs("div",{children:[i.jsx("div",{children:"Transfer ownership"}),i.jsx("input",{placeholder:"New admin user ID",value:b,onChange:e=>k(e.target.value)}),i.jsx("button",{onClick:()=>(async t=>{b&&(await n(`/orgs/${t}/transfer/`,{method:"POST",token:e,body:{user_id:Number(b)}}),k(""),S())})(t.id),children:"Transfer"})]})]})]},t.id)}))}),i.jsx("div",{children:i.jsx("button",{onClick:async()=>{},children:"Accept invite (paste token)"})})]})}function v({token:e,selectedOrgId:t,onSelectOrg:n}){return i.jsx("div",{children:i.jsxs("div",{children:[i.jsx(u,{token:e,selectedOrgId:t}),i.jsx(h,{token:e,onSelectOrg:n})]})})}export{c as AuthorPanel,h as Orgs,u as Proposals,d as SectionDiff,v as default};
